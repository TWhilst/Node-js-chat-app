---
- name: Setup Nodejs Socket.io Chat Application on Ubuntu Server
  hosts: chatapp
  become: true
  tasks:
    - name: Create a directory if it does not exist
      ansible.builtin.file:
        path: /var/www/html/chatapp
        state: directory

    - name: Run npm init in the chatapp directory
      command: npm init -y
      args:
        chdir: /var/www/html/chatapp

    # - name: Get json file from the local machine
    #   copy:
    #     src: "{{ jsonFile }}"
    #     dest: /var/www/html/chatapp/

    - name: Install express
      command: npm install -s express 
      args:
        chdir: /var/www/html/chatapp
    
    - name: Install socket.io
      command: npm install -s socket.io 
      args:
        chdir: /var/www/html/chatapp

    - name: Install http
      command: npm install -s http 
      args:
        chdir: /var/www/html/chatapp

    - name: Install body-parser
      command: npm install -s body-parser
      args:
        chdir: /var/www/html/chatapp

    - name: Get js file from the local machine
      copy:
        src: "{{ jsFile }}"
        dest: /var/www/html/chatapp/

    - name: Get html file from the local machine
      copy:
        src: "{{ htmlFile }}"
        dest: /var/www/html/chatapp/

    - name: Start the chat application using pm2
      command: pm2 restart app.js
      args:
        chdir: /var/www/html/chatapp

    - name: Ensure pm2 is running and enabled
      command: pm2 startup systemd
      args:
        chdir: /var/www/html/chatapp

    - name: Save pm2 process list
      command: pm2 save
      args:
        chdir: /var/www/html/chatapp

    - name: Ensure pm2 is running
      command: systemctl start pm2-root
      args:
        chdir: /var/www/html/chatapp


      